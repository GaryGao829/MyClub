<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN" "http://www.w3.org/TR/html4/frameset.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>restSQL HTTP API Explorer</title>
<script type="text/javascript">
	var LEVEL_CHILD = "child";
	var LEVEL_PARENT = "parent";
	var MEDIA_TYPE_JSON = "application/json";
	var MEDIA_TYPE_XML = "application/xml";
	var MEDIA_TYPE_URLENCODED = "application/x-www-form-urlencoded";

	var restsqlHost = "";
	var restsqlBaseUri = "/restsql";

	var requestType = "?";
	var resName = "?";
	var resParentName = "?";
	var resChildName = "?";
	var resHierarchical = false;

	function buildUrlEncodedBody(attributes) {
		var body = "";
		var i = 0;
		while (i < attributes.length) {
			if (attributes[i] != "" && attributes[i+1] != "") {
				if (body.length > 0) {
					body = body + "&";
				}
				body = body + escape(attributes[i]) + "=" + escape(attributes[i+1]);
			}
			i = i + 2;
		}
		return body;
	} 
	
	function prepResponseBodyForDisplay(responseBody, accept) {
		var html = "<pre style='margin-top:0'>";
		for (i = 0; i < responseBody.length; i++) {
			character = responseBody.charAt(i);
			//alert(character);
			if (character == "\t") {
				html = html + "&nbsp;&nbsp;&nbsp;";
			} else {
				if (accept == MEDIA_TYPE_XML) {
					if (character == "<") {
						html = html + "&lt;";
					} else if (character == ">") {
						html = html + "&gt;";
					} else {
						html = html + character;
					}
				} else {   // contentType == MEDIA_TYPE_JSON
					if (character == "\t") {
						html = html + "&nbsp;&nbsp;&nbsp;";
					} else {
						html = html + character;
					}
				}
			}
		}
		return html + "</pre>";
	}


	function getResUri() {
		return restsqlBaseUri + "/res/" + "Activity";
	}
	
	function optionSelected(self) {
		var button = self.name;
		if(button == "select"){
			submitRequest("GET", "", null, null, MEDIA_TYPE_JSON);
		}
		if(button == "insert"){
			window.location = "create-activity.html";
		}
		if(button == "delete"){
			deleteRequest(document.requestBuilder.activity_id.value);
		}
		if(button == "register"){
			var user_id = document.requestBuilder.user_id.value;
			var activity_id = document.requestBuilder.activityId.value;
			register(user_id, activity_id);
		}
	}
	
	//This function is for Query.
	function submitRequest(method, uri, requestBody, contentType, accept) {
		if (uri.indexOf(restsqlBaseUri) == -1) {
			// called from builder
			uri = getResUri() + uri;
		}
		var url = restsqlHost + uri;
		var responseBody = "";
		var xmlhttp;

		if (navigator.appName == "Microsoft Internet Explorer") {
			xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
		} else {
			xmlhttp = new XMLHttpRequest();
		}
		
		if (accept == null) {
			accept = MEDIA_TYPE_XML;
		}

		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4) {
				if (xmlhttp.status == 200) {
					responseBody = prepResponseBodyForDisplay(xmlhttp.responseText, accept);
				} else {
					responseBody = "<code>" + xmlhttp.responseText + "</code>";
				}
				document.getElementById("activity-content").innerHTML = responseBody;
				
			}
		}

		xmlhttp.open(method, url, true);
		xmlhttp.setRequestHeader("Accept", accept);
		if (contentType != null) {
			xmlhttp.setRequestHeader("Content-Type", contentType);
		}
		xmlhttp.send(requestBody);
	}
	
	//This function is for delete. The param is activity_id.
	//Here is required to enter id. But when table is formed, it can be selected and pass the id.
	function deleteRequest(activity_id){
		var uri = getResUri();
		var url = restsqlHost + uri + "/" + escape(activity_id);
		var responseBody = "";
		var xmlhttp;

		if (navigator.appName == "Microsoft Internet Explorer") {
			xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
		} else {
			xmlhttp = new XMLHttpRequest();
		}

		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4) {
				if (xmlhttp.status == 200) {
					responseBody = prepResponseBodyForDisplay(xmlhttp.responseText, MEDIA_TYPE_JSON);
				} else {
					responseBody = "<code>" + xmlhttp.responseText + "</code>";
				}
			}
		}
		xmlhttp.open("DELETE", url, true);
		xmlhttp.setRequestHeader("Accept", MEDIA_TYPE_JSON);
		xmlhttp.send(null);
	}
	
	//User registers activity
	function register(user_id, activity_id){
		var body = "";
		var contentType = "";
		var attributes = ["user_id",
							user_id,
							"activity_id",
							activity_id];
		body = buildUrlEncodedBody(attributes);
		alert(body);
		if (body == "") {
			alert("At least one name/value required");
			return;
		}
		contentType = MEDIA_TYPE_URLENCODED;
		
		var url = "/restsql" + "/res/" + "UserCampaign";
		var responseBody = "";
		var xmlhttp;

		if (navigator.appName == "Microsoft Internet Explorer") {
			xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
		} else {
			xmlhttp = new XMLHttpRequest();
		}

		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4) {
				if (xmlhttp.status == 200) {
					responseBody = prepResponseBodyForDisplay(xmlhttp.responseText, MEDIA_TYPE_JSON);
				}else{
					responseBody = "<code>" + xmlhttp.responseText + "</code>";
				}
				alert(responseBody);
			}
		}

		xmlhttp.open("POST", url, true);
		xmlhttp.setRequestHeader("Accept", MEDIA_TYPE_JSON);
		if (contentType != null) {
			xmlhttp.setRequestHeader("Content-Type", contentType);
		}
		xmlhttp.send(body);
	}
</script>
</head>
<body style="font-family:sans-serif">
<span style='font-weight:bold'>Activity</span><br/>
<form name="requestBuilder">
	<span style="font-weight:bold">Operation</span>
	<table>
		<tr><td><input type="button" name="select" value="Query" onclick="optionSelected(this)" /></td></tr>
		<tr><td><input type="button" name="insert" value="Create" onclick="optionSelected(this)" /></td></tr>
		<tr><td><input type="button" name="update" value="update" onclick="optionSelected(this)" /></td></tr>
		<tr><td><input type="button" name="delete" value="delete" onclick="optionSelected(this)" /></td></tr>
		<tr><td>Activity Id: <input type="text" name="activity_id" size="8"/></td></tr>
		<tr><td><input type="button" name="register" value="Register" onclick="optionSelected(this)" /></td></tr>
		<tr><td>User Id: <input type="text" name="user_id" size="8"/></td></tr>
		<tr><td>Activity Id: <input type="text" name="activityId" size="8"/></td></tr>
	</table>
</form>

<div id="activity-content" style="margin-top:0"></div>
</body>
</html>